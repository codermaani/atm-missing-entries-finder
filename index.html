<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ATM Discrepancy Finder</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        pre { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow: auto; }
        h3 { color: red; }
        label { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>ATM Discrepancy Finder</h1>
    <p>Upload DD45 files (multiple allowed) and EJ.txt files (multiple allowed), enter the discrepancy amount, then click Analyze.</p>
    
    <label for="discrepancyAmount">Discrepancy Amount (e.g., 2500):</label>
    <input type="number" id="discrepancyAmount" value="2500"><br><br>
    
    <label for="dd45files">DD45 Files:</label>
    <input type="file" id="dd45files" multiple accept=".html,.txt"><br><br>
    
    <label for="ejfiles">EJ.txt Files:</label>
    <input type="file" id="ejfiles" multiple accept=".txt"><br><br>
    
    <button onclick="analyze()">Analyze</button>
    
    <div id="result"></div>
    
    <script>
        function stripHtml(html) {
            html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            html = html.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
            const div = document.createElement('div');
            div.innerHTML = html;
            let text = div.textContent || div.innerText || '';
            text = text.replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            return text.replace(/\s+/g, ' ').trim();
        }
        
        function analyze() {
            const dd45Inputs = document.getElementById('dd45files').files;
            const ejInputs = document.getElementById('ejfiles').files;
            const discrepancyAmount = parseFloat(document.getElementById('discrepancyAmount').value) || 2500;
            if (dd45Inputs.length === 0) {
                alert('Please upload at least one DD45 file.');
                return;
            }
            let dd45Text = '';
            let ejText = '';
            let promises = [];
            
            for (let file of dd45Inputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        dd45Text += stripHtml(e.target.result) + '\n\n';
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            for (let file of ejInputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        ejText += e.target.result + '\n';
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            Promise.all(promises).then(() => {
                const lines = dd45Text.split(/\r?\n/);
                const transactions = [];
                let skipReasons = { empty: 0, pattern: 0, noDB: 0, insufficientFields: 0, invalidAmount: 0 };
                
                let html = '<h3>Debug: Total Lines Read: ' + lines.length + '</h3>';
                html += '<h3>Debug: First 10 Raw Lines from DD45 Files</h3><pre>';
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    html += lines[i].substring(0, 200) + (lines[i].length > 200 ? '...' : '') + '\n';
                }
                html += '</pre>';
                
                for (let line of lines) {
                    line = line.replace(/[\t\u00A0]+/g, ' ').replace(/\s+/g, ' ').trim();
                    if (!line) {
                        skipReasons.empty++;
                        continue;
                    }
                    if (line.match(/^(P|TOTAL|\*|<|<\/)/i)) {
                        skipReasons.pattern++;
                        continue;
                    }
                    
                    const fields = line.split(' ').filter(f => f.length > 0);
                    let dbIndex = -1;
                    for (let i = 0; i < fields.length; i++) {
                        if (fields[i] === 'DB') {
                            dbIndex = i;
                            break;
                        }
                    }
                    if (dbIndex === -1) {
                        skipReasons.noDB++;
                        continue;
                    }
                    if (fields.length < dbIndex + 4) {
                        skipReasons.insufficientFields++;
                        continue;
                    }
                    
                    const account = fields[0] || '';
                    const particulars = fields[1] || '';
                    const amountStr = fields[dbIndex + 1].replace(/,/g, '').replace(/[^0-9.]/g, '');
                    const amount = parseFloat(amountStr);
                    if (isNaN(amount)) {
                        skipReasons.invalidAmount++;
                        continue;
                    }
                    
                    const card = fields[dbIndex + 2] || '';
                    const imd = fields[dbIndex + 3] || '';
                    const id = fields[dbIndex + 4] || '';
                    const stan = fields[dbIndex + 5] || '';
                    const datetimeParts = [];
                    for (let j = dbIndex + 6; j < fields.length && j < dbIndex + 8; j++) {
                        if (fields[j] && fields[j].match(/\d{2}-\w{3}-\d{4}/)) {
                            datetimeParts.push(fields[j]);
                            if (j + 1 < fields.length) datetimeParts.push(fields[j + 1]);
                            break;
                        }
                    }
                    const datetime = datetimeParts.join(' ') || '';
                    
                    transactions.push({ 
                        account, 
                        particulars, 
                        amount, 
                        amountStr, 
                        card, 
                        imd, 
                        id, 
                        stan, 
                        datetime 
                    });
                }
                
                const candidates = transactions.filter(t => Math.abs(t.amount - discrepancyAmount) <= 1);
                
                html += `<h2>Potential Missing Entries (Amount: ${discrepancyAmount} PKR)</h2>`;
                html += '<p>Total transactions parsed: ' + transactions.length + '</p>';
                if (candidates.length === 0) {
                    html += `<p>No transactions found for ${discrepancyAmount} PKR. Check debug sections.</p>`;
                } else {
                    html += '<table><tr><th>Account</th><th>Amount</th><th>Date/Time</th><th>STAN</th><th>Card</th></tr>';
                    for (let t of candidates) {
                        html += `<tr><td>${t.account}</td><td>${t.amountStr}</td><td>${t.datetime}</td><td>${t.stan}</td><td>${t.card}</td></tr>`;
                    }
                    html += '</table>';
                }
                
                // Debug: Show all parsed transactions
                html += '<h3>Debug: All Parsed Transactions</h3>';
                if (transactions.length > 0) {
                    html += '<table><tr><th>Account</th><th>Amount</th><th>Date/Time</th><th>STAN</th><th>Card</th></tr>';
                    for (let t of transactions) {
                        html += `<tr><td>${t.account}</td><td>${t.amountStr} (${t.amount})</td><td>${t.datetime}</td><td>${t.stan}</td><td>${t.card}</td></tr>`;
                    }
                    html += '</table>';
                } else {
                    html += '<p>No transactions parsed.</p>';
                }
                
                html += '<h3>Debug: Skip Reasons</h3><pre>';
                html += `Empty lines: ${skipReasons.empty}\n`;
                html += `Lines matching P/TOTAL/*/<: ${skipReasons.pattern}\n`;
                html += `Lines without DB: ${skipReasons.noDB}\n`;
                html += `Lines with insufficient fields: ${skipReasons.insufficientFields}\n`;
                html += `Lines with invalid amount: ${skipReasons.invalidAmount}\n`;
                html += '</pre>';
                
                if (transactions.length === 0) {
                    html += '<h3>Debug: Sample Processed Lines (First 5 Non-Empty)</h3><pre>';
                    let count = 0;
                    for (let line of lines) {
                        line = line.replace(/[\t\u00A0]+/g, ' ').replace(/\s+/g, ' ').trim();
                        if (line && !line.match(/^(P|TOTAL|\*|<|<\/)/i) && count < 5) {
                            const fields = line.split(' ').filter(f => f.length > 0);
                            html += 'Line: ' + line.substring(0, 150) + '\nFields (' + fields.length + '): ' + fields.slice(0, 10).join(', ') + '\n\n';
                            count++;
                        }
                    }
                    if (count === 0) html += 'No non-skipped lines foundâ€”files may be empty or fully HTML-wrapped.';
                    html += '</pre>';
                }
                
                html += '<h2>EJ Log (for Manual Cross-Check)</h2><pre>' + (ejText.substring(0, 5000) || 'No EJ files uploaded.') + '</pre>';
                
                document.getElementById('result').innerHTML = html;
            });
        }
    </script>
</body>
</html>
