<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ATM Discrepancy Finder (Online)</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        pre { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow: auto; }
        h3 { color: red; } /* For debug visibility */
    </style>
</head>
<body>
    <h1>ATM Discrepancy Finder (Online)</h1>
    <p>Upload DD45 files (multiple allowed) and EJ.txt files (multiple allowed), then click Analyze to find transactions of 2500 PKR.</p>
    
    <label for="dd45files">DD45 Files:</label>
    <input type="file" id="dd45files" multiple accept=".html,.txt"><br><br>
    
    <label for="ejfiles">EJ.txt Files:</label>
    <input type="file" id="ejfiles" multiple accept=".txt"><br><br>
    
    <button onclick="analyze()">Analyze</button>
    
    <div id="result"></div>
    
    <script>
        // Function to strip HTML tags and get plain text
        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }
        
        function analyze() {
            const dd45Inputs = document.getElementById('dd45files').files;
            const ejInputs = document.getElementById('ejfiles').files;
            if (dd45Inputs.length === 0) {
                alert('Please upload at least one DD45 file.');
                return;
            }
            let dd45Text = '';
            let ejText = '';
            let promises = [];
            
            // Read all DD45 files
            for (let file of dd45Inputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        dd45Text += stripHtml(e.target.result) + '\n\n'; // Add extra newline for separation
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            // Read all EJ files
            for (let file of ejInputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        ejText += e.target.result + '\n';
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            Promise.all(promises).then(() => {
                // Split into lines
                const lines = dd45Text.split(/\r?\n/);
                const transactions = [];
                const discrepancyAmount = 2500; // Edit this if the difference amount changes
                
                // Debug: Total lines and first 10 raw lines
                let html = '<h3>Debug: Total Lines Read: ' + lines.length + '</h3>';
                html += '<h3>Debug: First 10 Raw Lines from DD45 Files</h3><pre>';
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    html += lines[i].substring(0, 200) + (lines[i].length > 200 ? '...' : '') + '\n'; // Truncate long lines
                }
                html += '</pre>';
                
                for (let line of lines) {
                    // Aggressive normalization: strip extra spaces, tabs, non-breaking spaces
                    line = line.replace(/[\t\u00A0]+/g, ' ').replace(/\s+/g, ' ').trim();
                    if (!line || line.match(/^(P|TOTAL|\*|<|<\/)/i)) continue;
                    
                    // Split by spaces
                    const fields = line.split(' ').filter(f => f.length > 0);
                    // Look for 'DB' in position 2 or nearby, relaxed count >=6
                    let dbIndex = -1;
                    for (let i = 0; i < Math.min(5, fields.length); i++) {
                        if (fields[i] === 'DB') {
                            dbIndex = i;
                            break;
                        }
                    }
                    if (dbIndex === -1 || fields.length < dbIndex + 4) continue;
                    
                    const account = fields[0];
                    const particulars = fields[1];
                    const amountStr = fields[dbIndex + 1].replace(/,/g, '');
                    const amount = parseFloat(amountStr);
                    if (isNaN(amount)) continue;
                    
                    const card = fields[dbIndex + 2];
                    const imd = fields[dbIndex + 3];
                    const id = fields[dbIndex + 4];
                    const stan = fields[dbIndex + 5] || '';
                    const datetimeParts = [];
                    for (let j = dbIndex + 6; j < fields.length && j < dbIndex + 8; j++) {
                        if (fields[j].match(/\d{2}-\w{3}-\d{4}/)) datetimeParts.push(fields[j]);
                    }
                    const datetime = datetimeParts.join(' ') || '';
                    
                    transactions.push({ 
                        account, 
                        particulars, 
                        amount, 
                        amountStr, 
                        card, 
                        imd, 
                        id, 
                        stan, 
                        datetime 
                    });
                }
                
                // Filter for discrepancy amount (exact or close match for floats)
                const candidates = transactions.filter(t => Math.abs(t.amount - discrepancyAmount) < 0.01);
                
                // Build output
                html += '<h2>Potential Missing Entries (Amount: 2500 PKR)</h2>';
                html += '<p>Total transactions parsed: ' + transactions.length + '</p>';
                if (candidates.length === 0) {
                    html += '<p>No transactions found for 2500 PKR. Check debug above.</p>';
                } else {
                    html += '<table><tr><th>Account</th><th>Amount</th><th>Date/Time</th><th>STAN</th><th>Card</th></tr>';
                    for (let t of candidates) {
                        html += `<tr><td>${t.account}</td><td>${t.amountStr}</td><td>${t.datetime}</td><td>${t.stan}</td><td>${t.card}</td></tr>`;
                    }
                    html += '</table>';
                }
                
                // Additional debug if zero transactions
                if (transactions.length === 0) {
                    html += '<h3>Debug: Sample Processed Lines (First 5 Non-Empty)</h3><pre>';
                    let count = 0;
                    for (let line of lines) {
                        line = line.replace(/[\t\u00A0]+/g, ' ').replace(/\s+/g, ' ').trim();
                        if (line && !line.match(/^(P|TOTAL|\*|<|<\/)/i) && count < 5) {
                            const fields = line.split(' ').filter(f => f.length > 0);
                            html += 'Line: ' + line.substring(0, 150) + '\nFields (' + fields.length + '): ' + fields.slice(0, 10).join(', ') + '\n\n';
                            count++;
                        }
                    }
                    if (count === 0) html += 'No non-skipped lines foundâ€”files may be empty or fully HTML-wrapped.';
                    html += '</pre>';
                }
                
                html += '<h2>EJ Log (for Manual Cross-Check)</h2><pre>' + (ejText.substring(0, 5000) || 'No EJ files uploaded. (Showing first 5000 chars)') + '</pre>';
                
                document.getElementById('result').innerHTML = html;
            });
        }
    </script>
</body>
</html>
