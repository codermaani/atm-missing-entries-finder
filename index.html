<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ATM Discrepancy Finder</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        pre { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow: auto; }
        h3 { color: red; }
        label { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>ATM Discrepancy Finder</h1>
    <p>Upload DD45 files (multiple allowed, .txt preferred) and EJ.txt files, enter the discrepancy amount, then click Analyze.</p>
    
    <label for="discrepancyAmount">Discrepancy Amount (e.g., 2500):</label>
    <input type="number" id="discrepancyAmount" value="2500"><br><br>
    
    <label for="dd45files">DD45 Files:</label>
    <input type="file" id="dd45files" multiple accept=".html,.txt"><br><br>
    
    <label for="ejfiles">EJ.txt Files:</label>
    <input type="file" id="ejfiles" multiple accept=".txt"><br><br>
    
    <button onclick="analyze()">Analyze</button>
    
    <div id="result"></div>
    
    <script>
        function stripHtml(html) {
            html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            html = html.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
            html = html.replace(/<\/?(tr|br|p|div)\b[^>]*>/gi, '\n');
            html = html.replace(/<[^>]+>/g, '');
            html = html.replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            return html.replace(/[ \t]+/g, ' ').replace(/\n\s*\n/g, '\n').trim();
        }
        
        function analyze() {
            const dd45Inputs = document.getElementById('dd45files').files;
            const ejInputs = document.getElementById('ejfiles').files;
            const discrepancyAmount = parseFloat(document.getElementById('discrepancyAmount').value) || 2500;
            if (dd45Inputs.length === 0) {
                alert('Please upload at least one DD45 file.');
                return;
            }
            let dd45Text = '';
            let ejText = '';
            let rawDd45Text = '';
            let promises = [];
            
            for (let file of dd45Inputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        rawDd45Text += e.target.result.substring(0, 4000) + '\n\n';
                        dd45Text += stripHtml(e.target.result) + '\n\n';
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            for (let file of ejInputs) {
                promises.push(new Promise((resolve) => {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        ejText += e.target.result + '\n';
                        resolve();
                    };
                    reader.readAsText(file);
                }));
            }
            
            Promise.all(promises).then(() => {
                const lines = dd45Text.split(/\n/);
                const transactions = [];
                let skipReasons = { empty: 0, pattern: 0, noDB: 0, insufficientFields: 0, invalidAmount: 0, regexFail: 0 };
                let regexMatches = [];
                
                let html = '<h3>Debug: Raw File Content (First 4000 chars)</h3><pre>' + rawDd45Text.substring(0, 8000) + '</pre>';
                html += '<h3>Debug: Total Lines Read: ' + lines.length + '</h3>';
                html += '<h3>Debug: First 10 Raw Lines from DD45 Files (Post-Strip)</h3><pre>';
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    html += lines[i].substring(0, 200) + (lines[i
